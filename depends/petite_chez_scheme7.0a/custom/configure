#! /bin/sh

if [ -f Makefile ] ; then /bin/mv -f Makefile Makefile.bak ; fi
if [ -f Mf-install ] ; then /bin/mv -f Mf-install Mf-install.bak ; fi

machs=""; last=""; sep0=""; sep1=""; sep2=""; sep3=""; sep4=" and ";
for fn in Mf-* ; do
  case $fn in
    Mf-install|Mf-install.in|Mf-none)
       ;;
    *) machs=$machs$sep0$last
       last=`echo $fn | sed -e 's/Mf-//'`
       sep0=$sep1; sep1=", "; sep2=$sep3; sep3=$sep4; sep4=", and "
       ;;
  esac
done
machs=$machs$sep2$last

m=""
threads=no
bit64=no
temproot=""
relink=no
heaps=no
while [ $# != 0 ] ; do
  case $1 in
    -m=*)
      m=`echo $1 | sed -e 's/^-m=//'`
      ;;
    --machine=*)
      m=`echo $1 | sed -e 's/^--machine=//'`
      ;;
    --threads)
      threads=yes
      ;;
    --64)
      bit64=yes
      ;;
    --installprefix=*)
      installprefix=`echo $1 | sed -e 's/^--installprefix=//'`
      ;;
    --temproot=*)
      temproot=`echo $1 | sed -e 's/^--temproot=//'`
      ;;
    --force-relink)
      relink=yes
      ;;
    --build-heaps)
      heaps=yes
      ;;
    --help)
      echo "Purpose:"
      echo "  $0 determines the machine type and constructs a custom Makefile"
      echo "  and Mf-install, taking into account the options below."
      echo ""
      echo "Options:"
      echo "  --machine=<machine type>    explicitly specify machine type"
      echo "  -m=<machine type>           same as --machine <machine type>"
      echo "  --threads                   specify threaded version, if supported"
      echo "  --64                        specify 64-bit version, if supported"
      echo "  --force-relink              recreate executable on this machine"
      echo "  --build-heaps               create saved heap images"
      echo "  --installprefix=<pathname>  final installation root (default: /usr)"
      echo "  --temproot=<pathname>       staging root (default: empty)"
      echo "                              (install at installprefix within temproot)"
      echo ""
      echo "Available machine types: $machs"
      echo ""
      echo "Examples:"
      echo "  $0 --machine=i3le"
      echo ""
      echo "  set machine-type to i3le rather than to determined type"
      echo ""
      echo "  $0 --threads --installprefix=/usr/local"
      echo ""
      echo "  specify threaded version and set installation directory to /usr/local."
      echo ""
      echo "  $0 --installprefix=/usr/local --temproot=/tmp"
      echo ""
      echo "  declare the final destination to be /usr/local but staging area"
      echo "  to be /tmp/usr/local.  Make will record the final destination in"
      echo "  the installed manual page but actually install the system in the"
      echo "  staging area."
      echo ""
      exit 0
      ;;
    *)
      echo "option '$1' unrecognized or missing an argument; try $0 --help"
      exit 1
      ;;
  esac
  shift
done

if [ "$m" = "" ] ; then
  case `uname` in
    Linux)
      if uname -a | egrep 'i386|i686|athlon' > /dev/null 2>&1 ; then
        if [ $bit64 = yes ] ; then echo "no 64-bit Linux support"; exit 1; fi
        if [ $threads = yes ] ; then m=ti3le; else m=i3le; fi
      fi
      ;;
    Darwin)
      if uname -a | grep powerpc > /dev/null 2>&1 ; then
        if [ $bit64 = yes ] ; then echo "no 64-bit MacOS X support"; exit 1; fi
        if [ $threads = yes ] ; then echo "no MacOS X threads support"; exit 1; fi
        m=ppcosx
      fi
      ;;
    SunOS)
      if uname -a | grep sparc > /dev/null 2>&1 ; then
        if [ $bit64 = yes ] ; then
          if [ $threads = yes ] ; then m=tsp64; else m=sp64; fi
        else
          if [ $threads = yes ] ; then m=tsps2; else m=sps2; fi
        fi
      fi
      ;;
  esac
fi

if [ "$m" = "" ] ; then
  echo "machine type unknown; rerun as $0 -m <machine type>"
  echo "available machine types: $machs"
  exit 1
fi

if [ "$installprefix" = "" ] ; then
  installprefix="/usr"
fi

sed -e "s/^m=none\$/m=$m/"\
    -e "s/ForceRelink=no/ForceRelink=$relink/"\
    -e "s/BuildHeaps=no/BuildHeaps=$heaps/"\
    Makefile.in > Makefile

sed -e "s;^InstallPrefix=/usr\$;InstallPrefix=$installprefix;"\
    -e "s;^TempRoot=$;TempRoot=$temproot;"\
    Mf-install.in > Mf-install
