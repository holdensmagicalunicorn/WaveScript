#! /bin/sh

machs=""; last=""; sep0=""; sep1=""; sep2=""; sep3=""; sep4=" and ";
for fn in Mf-* ; do
  case $fn in
    Mf-install*|Mf-install.in|Mf-none)
       ;;
    *) machs=$machs$sep0$last
       last=`echo $fn | sed -e 's/Mf-//'`
       sep0=$sep1; sep1=", "; sep2=$sep3; sep3=$sep4; sep4=", and "
       ;;
  esac
done
machs=$machs$sep2$last

m=""
threads=no
bit64=no
temproot=""
relink=no
heaps=no
help=no
installprefix=""
installman=""

while [ $# != 0 ] ; do
  case $1 in
    -m=*)
      m=`echo $1 | sed -e 's/^-m=//'`
      ;;
    --machine=*)
      m=`echo $1 | sed -e 's/^--machine=//'`
      ;;
    --threads)
      threads=yes
      ;;
    --64)
      bit64=yes
      ;;
    --installprefix=*)
      installprefix=`echo $1 | sed -e 's/^--installprefix=//'`
      ;;
    --installman=*)
      installman=`echo $1 | sed -e 's/^--installman=//'`
      ;;
    --temproot=*)
      temproot=`echo $1 | sed -e 's/^--temproot=//'`
      ;;
    --force-relink)
      relink=yes
      ;;
    --build-heaps)
      heaps=yes
      ;;
    --help)
      help=yes
      ;;
    *)
      echo "option '$1' unrecognized or missing an argument; try $0 --help"
      exit 1
      ;;
  esac
  shift
done

if [ "$m" = "" ] ; then
  case `uname` in
    Linux)
      if uname -a | egrep 'i386|i686|athlon' > /dev/null 2>&1 ; then
        if [ $bit64 = yes ] ; then echo "no 64-bit Linux support"; exit 1; fi
        if [ $threads = yes ] ; then m=ti3le; else m=i3le; fi
      fi
      ;;
    FreeBSD)
      if uname -a | egrep 'i386|i686|athlon' > /dev/null 2>&1 ; then
        if [ $bit64 = yes ] ; then echo "no 64-bit FreeBSD support"; exit 1; fi
        if [ $threads = yes ] ; then m=ti3fb; else m=i3fb; fi
      fi
      ;;
    Darwin)
      if uname -a | grep powerpc > /dev/null 2>&1 ; then
        if [ $bit64 = yes ] ; then echo "no 64-bit MacOS X support"; exit 1; fi
        if [ $threads = yes ] ; then echo "no MacOS X threads support"; exit 1; fi
        m=ppcosx
      fi
      ;;
    SunOS)
      if uname -a | grep sparc > /dev/null 2>&1 ; then
        if [ $bit64 = yes ] ; then
          if [ $threads = yes ] ; then m=tsp64; else m=sp64; fi
        else
          if [ $threads = yes ] ; then m=tsps2; else m=sps2; fi
        fi
      fi
      ;;
  esac
fi

if [ "$installprefix" = "" ] ; then
  case $m in
    i3le|ti3le)
      installprefix=/usr
      ;;
    i3fb|ti3fb)
      installprefix=/usr/local
      ;;
    ppcosx)
      installprefix=/usr
      ;;
    sps2|tsps2|sp64|tsp64)
      installprefix=/usr/local
      ;;
    *)
      installprefix=/usr
      ;;
  esac
fi

if [ "$installman" = "" ] ; then
  case $m in
    i3le|ti3le)
      installman=$installprefix/man
      ;;
    i3fb|ti3fb|ppcosx|sps2|tsps2|sp64|tsp64)
      if [ "$installprefix" = "/usr" ] ; then
        installman=/usr/share/man
      else
        installman=$installprefix/man
      fi
      ;;
    *)
      installman=$installprefix/man
      ;;
  esac
fi

if [ "$help" = "yes" ]; then
  echo "Purpose:"
  echo "  $0 determines the machine type and constructs a custom Makefile"
  echo "  and Mf-install, taking into account the options below."
  echo ""
  echo "Options (defaults shown in parens):"
  echo "  --machine=<machine type>    explicitly specify machine type ($m)"
  echo "  -m=<machine type>           same as --machine <machine type> ($m)"
  echo "  --threads                   specify threaded version, if supported ($threads)"
  echo "  --64                        specify 64-bit version, if supported ($bit64)"
  echo "  --force-relink              recreate executable on this machine ($relink)"
  echo "  --build-heaps               create saved heap images ($heaps)"
  echo "  --installprefix=<pathname>  final installation root ($installprefix)"
  echo "  --installman=<pathname>     manpage directory ($installman)"
  echo "  --temproot=<pathname>       staging root ($temproot)"
  echo ""
  echo "Available machine types: $machs"
  echo ""
  echo "Examples:"
  echo "  $0 --machine=i3le"
  echo ""
  echo "  set machine-type to i3le rather than to determined type"
  echo ""
  echo "  $0 --threads --installprefix=/usr/local"
  echo ""
  echo "  specify threaded version and set installation directory to /usr/local."
  echo ""
  echo "  $0 --installprefix=/usr/local --temproot=/tmp"
  echo ""
  echo "  declare the final destination to be /usr/local but staging area"
  echo "  to be /tmp/usr/local.  Make will record the final destination in"
  echo "  the installed manual page but actually install the system in the"
  echo "  staging area."
  echo ""
  exit 0
fi

if [ "$m" = "" ] ; then
  echo "machine type unknown; rerun as $0 -m <machine type>"
  echo "available machine types: $machs"
  exit 1
fi

if [ ! -e Mf-$m ] ; then
  echo "unavailable machine type $m; rerun as $0 -m <machine type>"
  echo "available machine types: $machs"
  exit 1
fi

if [ -f Makefile ] ; then /bin/mv -f Makefile Makefile.bak ; fi
if [ -f Mf-install ] ; then /bin/mv -f Mf-install Mf-install.bak ; fi

sed -e "s/^m=none\$/m=$m/"\
    -e "s/ForceRelink=no/ForceRelink=$relink/"\
    -e "s/BuildHeaps=no/BuildHeaps=$heaps/"\
    Makefile.in > Makefile

sed -e "s;^InstallPrefix=.*\$;InstallPrefix=$installprefix;"\
    -e "s;^InstallMan=.*\$;InstallMan=$installman/man1;"\
    -e "s;^TempRoot=$;TempRoot=$temproot;"\
    Mf-install.in > Mf-install
