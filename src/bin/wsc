#!/bin/sh

#TMP=/tmp/`whoami`/wavescript_parsed.tmp

if [ ! -f "$1" ];
then echo Usage: "wsc <file> <options ...>";
#     echo   (Options: -b  Build cpp file.)
     echo 
     echo   File \"$1\" does not exist.
     exit 1;
fi

if [ ! -d /tmp/`whoami` ]; 
then mkdir /tmp/`whoami`;
fi


# if [ ! `which wsparse` ]
# then echo \"wsparse\" command not found.  Compile it!
#      exit 1;
# fi

# Make sure we don't get polluted by any out of date files.
export WAVESCRIPTQUERYFILE=`pwd`/query.cpp
rm -f $WAVESCRIPTQUERYFILE
rm -f $WAVESCOPED/WaveScriptQuery.cpp
rm -f $WAVESCOPED/WaveScriptQuery-*

# Now do the parsing and compilation.
#wsparse $1 > $TMP

D=`dirname "$1"`
B=`basename "$1"`
abspath="`cd \"$D\" 2>/dev/null && pwd || echo \"$D\"`/$B"

export REGIMENT_OR_WAVESCRIPT=WS
if regiment wscomp $abspath ${1+"$@"} ;
then echo
else #rm -f $TMP; 
    echo Compilation aborted: \"regiment wscomp\" exited with error code.
    exit 1;
fi
#rm -f $TMP

# If this flag is set, we stop here.
# HACK: accepts the argument only in this position:
#if test "$2" == "-c0" ; 
#then exit 0
#fi

if [ ! -d "$WAVESCOPED" ]; 
then echo WAVESCOPED directory, \"$WAVESCOPED\", does not exist.  Can\'t execute query.; 
     exit 1;
fi

#echo
#echo
#(cd $WAVESCOPED; make WaveScriptQuery)
#echo Writing scipt \"run_query\".  Use it to invoke the compiled query.
#echo '#!/bin/sh' > run_query
##echo '(cd $WAVESCOPED; ./run_WaveScriptQuery)' >> run_query
#echo '$WAVESCOPED/run_WaveScriptQuery $*' >> run_query
#chmod +x run_query

echo Compiling query file.
g++ -Wall -Werror -I$WAVESCOPED/include -g -fPIC -Wno-unused-variable -DSegList -DuseArray -lfftw3f -lpthread ./query.cpp $WAVESCOPED/libws-SMSegList.so -o query.exe

echo
echo "Executable output to 'query.exe'."


# ar -cr libws-SMSegList.a obj-SMSegList/PrintBox.o obj-SMSegList/MiscLog.o obj-SMSegList/Time.o obj-SMSegList/MiscOpt.o obj-SMSegList/Sched.o obj-SMSegList/WSSched.o obj-SMSegList/SchedThread.o obj-SMSegList/WSBox.o obj-SMSegList/WSQueue.o obj-SMSegList/WSSource.o obj-SMSegList/Heartbeat.o obj-SMSegList/RawFileSource.o obj-SMSegList/MemorySource.o obj-SMSegList/PipeMemSource.o obj-SMSegList/RawFileSink.o obj-SMSegList/PipeFileSource.o obj-SMSegList/Boxes.o obj-SMSegList/RawSeg.o obj-SMSegList/SegList.o obj-SMSegList/Thread.o obj-SMSegList/WSSystem.o obj-SMSegList/ENSBox.o obj-SMSegList/EEGAcquireBox.o obj-SMSegList/WSQuery.o obj-SMSegList/WSPartitionScheduler.o obj-SMSegList/WSSchedCorefit.o obj-SMSegList/UniSet.o

# ./wtf g++   -Wall -Werror -I./include -g -fPIC -DSegList -DuseArray  -Wno-unused-variable -pg  -c WaveScriptQuery.cpp -o obj-SMSegList/WaveScriptQuery.o -MD -MF obj-SMSegList/WaveScriptQuery.d

# Now linking...
# ./wtf g++ -pg  -Wall -Werror -I./include -g -fPIC -DSegList -DuseArray   obj-SMSegList/WaveScriptQuery.o -lfftw3f -lpthread libws-SMSegList.so -o WaveScriptQuery-SMSegList 


############################################################


# ar -cr 
# libws-SMSegList.a 
# obj-SMSegList/PrintBox.o 
# obj-SMSegList/MiscLog.o 
# obj-SMSegList/Time.o obj-SMSegList/MiscOpt.o obj-SMSegList/Sched.o obj-SMSegList/WSSched.o obj-SMSegList/SchedThread.o obj-SMSegList/WSBox.o obj-SMSegList/WSQueue.o obj-SMSegList/WSSource.o obj-SMSegList/Heartbeat.o obj-SMSegList/RawFileSource.o obj-SMSegList/MemorySource.o obj-SMSegList/PipeMemSource.o obj-SMSegList/RawFileSink.o obj-SMSegList/PipeFileSource.o obj-SMSegList/Boxes.o obj-SMSegList/RawSeg.o obj-SMSegList/SegList.o obj-SMSegList/Thread.o obj-SMSegList/WSSystem.o obj-SMSegList/ENSBox.o obj-SMSegList/EEGAcquireBox.o obj-SMSegList/WSQuery.o obj-SMSegList/WSPartitionScheduler.o obj-SMSegList/WSSchedCorefit.o obj-SMSegList/UniSet.o


# g++   -Wall -Werror -I$WAVESCOPED/include -g -fPIC -DSegList -DuseArray  -Wno-unused-variable -c WaveScriptQuery.cpp 
#    -o obj-SMSegList/WaveScriptQuery.o -MD -MF obj-SMSegList/WaveScriptQuery.d


# # Now linking...
# g++ -pg  -Wall -Werror -I./include -g -fPIC -DSegList -DuseArray   obj-SMSegList/WaveScriptQuery.o -lfftw3f -lpthread libws-SMSegList.so -o WaveScriptQuery-SMSegList 




# g++   -Wall -Werror -I$WAVESCOPED/include -g -fPIC -DSegList -DuseArray  -c WaveScriptQuery.cpp 
#    -o obj-SMSegList/WaveScriptQuery.o -MD -MF obj-SMSegList/WaveScriptQuery.d

# # Now linking...
# g++ -pg  -Wall -Werror -I$WAVESCOPED/include -g -fPIC -Wno-unused-variable -DSegList -DuseArray -lfftw3f -lpthread ./query.cpp $WAVESCOPED/libws-SMSegList.so -o a.out

# g++ -pg  -Wall -Werror -I$WAVESCOPED/include -g -fPIC -Wno-unused-variable -DSegList -DuseArray -lfftw3f -lpthread ./query.cpp $WAVESCOPED/libws-SMSegList.so -o a.out





