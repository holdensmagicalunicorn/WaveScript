#!/bin/sh

# TODO: ACCEPTING -o ARGUMENT BUT IT'S NOT USED CURRENTLY.

#TMP=/tmp/`whoami`/wavescript_parsed.tmp

TMP=`dirname $0`
if [ -f "$TMP/assert_regimentd" ]; 
then source "$TMP/assert_regimentd"; fi

CCPASSTHRU=""
REGPASSTHRU=""
FILE=""
OUTFILE=query.cpp
NOGCC=0

while [ $# != 0 ];  do 
  if [ "$1" == "-no-gcc" ]
  then NOGCC=1;
  elif [ "$1" == "-o" ]
  then shift;
       OUTFILE="$1"; 
  elif [ "$1" == "-exit-error" ]
  then REGPASSTHRU="$REGPASSTHRU $1"; 
  elif [ "$1" == "-O0" ] || 
       [ "$1" == "-O1" ] || 
       [ "$1" == "-O2" ] || 
       [ "$1" == "-O3" ];
  then CCPASSTHRU="$CCPASSTHRU $1"; 
#  elif [ `echo $1 | sed` == "-" ]
#  then echo "Unknown flag: $1"
  else FILE="$1"; 
  fi
  shift;
done;

if [ ! -f "$FILE" ];
then echo Usage: "wsc <file> <options ...>";
#     echo   (Options: -b  Build cpp file.)
     echo 
     echo   File \"$FILE\" does not exist.
     exit 1;
fi

if [ ! -d /tmp/`whoami` ]; 
then mkdir /tmp/`whoami`; 
fi


D=`dirname "$FILE"`
B=`basename "$FILE"`
abspath="`cd \"$D\" 2>/dev/null && pwd || echo \"$D\"`/$B"

# Clean first:
rm -f "$OUTFILE"

if [ "$REGIMENTEXEC" == "" ]; then REGIMENTEXEC=regiment; fi

export REGIMENT_OR_WAVESCRIPT=WS
if "$REGIMENTEXEC" wscomp $abspath $REGPASSTHRU ;
then echo
else #rm -f $TMP; 
    echo Compilation aborted: \"regiment wscomp\" exited with error code.
    exit 1;
fi
#rm -f $TMP

# If this flag is set, we stop here.
# HACK: accepts the argument only in this position:
#if test "$2" == "-c0" ; 
#then exit 0
#fi

if [ ! -d "$WAVESCOPED" ]; 
then echo WAVESCOPED directory, \"$WAVESCOPED\", does not exist.  Can\'t execute query.; 
     exit 1;
fi

#echo
#echo
#(cd $WAVESCOPED; make WaveScriptQuery)
#echo Writing scipt \"run_query\".  Use it to invoke the compiled query.
#echo '#!/bin/sh' > run_query
##echo '(cd $WAVESCOPED; ./run_WaveScriptQuery)' >> run_query
#echo '$WAVESCOPED/run_WaveScriptQuery $*' >> run_query
#chmod +x run_query

if [ "$NOGCC" == "0" ] &&  wsc-g++ $CCPASSTHRU ./query 
then echo
     echo "Executable output to 'query.exe'."
else exit 1;
fi;
