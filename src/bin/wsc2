#!/bin/bash

export REGFLAG=wsc2

rm -f query.c
if wsc $* -no-gcc;
then echo ERROR, wsc2 failed with code $?.; exit 1;
else echo
fi

MATCH=`echo $FIRST | grep "^//WSLIBDEPS:"`
if [ "$MATCH" != "" ];
then 
   export EXTRALIBS=`echo $FIRST | sed "s/\/\/WSLIBDEPS://"`
   export WS_LINK="$WS_LINK $EXTRALIBS"
   echo Linking extra libraries requested by query file: $EXTRALIBS
fi

if [ -f "query.c" ]; 
then exec wsc2-gcc;
else echo query.c not found...
fi

## Run again to profile branches:
# ./query.exe
# CMD="gcc $OPTFLAGS -o query.exe $WS_LINK query.c -fbranch-probabilities"
# echo $CMD; $CMD



# GCC flags not enabled by -O3:
#       -fforce-addr
#       -funroll-loops / unroll-all-loops
#       -finline-limit=n
#       -fno-keep-static-consts
#       -fmerge-all-constants (non conforming behavior)

#       -fsched-spec-load
#       -fsched-spec-load-dangerous
#       -fmove-all-movables

#       -fbranch-probabilities
#       -fno-guess-branch-probability

#       -fprefetch-loop-arrays

# Experimental:
#       -fnew-ra - Experimental register allocator
#       -ftracer
#       -fssa  - not ready for productio use
#      -ffunction-sections  -fdata-sections  -- place functions and data into their own sections, helps linker.


# Our array representation is going to require disabling:
#       -fstrict-aliasing


# May or may not increase performance (might disable)
#       -fcrossjumping
#       -freduce-all-givs
#       -falign-labels


# DANGER opts that must be turned on by hand, breaks IEEE math.
#       -ffast-math
#       -fno-math-errno
#       -funsafe-math-optimizations
#       -ffinite-math-only   - disable handling of NANs and INFs
#       -fno-trapping-math   - don't worry about DIV zero and so on
#       -fsingle-precision-constant



