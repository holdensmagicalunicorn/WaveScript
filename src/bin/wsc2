#!/bin/bash

export REGFLAG=wsc2

# Get out only the relevant options:
RELEVANT=`getopt -a -l "gcc:,nogcc,no-gcc,O0,O1,O2,O3" -o ":" -- "$@"`
#echo wsc2 getopt result: $RELEVANT

# I would like to pass only the relevant options on to "wsc", but I
# can't currently get getopt to do everything I want it to, i.e. pass
# through everything not handled in after the "--".

rm -f query.c query.exe
if wsc $* -exit-error -no-gcc
then echo
else echo ERROR, wsc2 failed with code $?.; exit 1;
fi

eval set -- "$RELEVANT"

NOGCC=
while [ $# != 0 ];  do 
#for flag in $RELEVANT; do 
 flag=$1
 #echo Handling flag: $flag
 case $flag in 
   # Sadly duplicating the COPTFLAG business because no way for "wsc" to pass the env vars back up.
   "--O0" ) COPTFLAG="$flag";;
   "--O1" ) COPTFLAG="$flag";;
   "--O2" ) COPTFLAG="$flag";;
   "--O3" ) COPTFLAG="$flag";;
   "--nogcc" | "--no-gcc" ) NOGCC=true;;
   "--gcc" ) export CC="$2"; shift;;
   "--" ) break;;
#   *) echo "  Uh, unhandled...";;
 esac;
 shift;
done
export COPTFLAG


if ! [ -f "query.c" ]
then echo "query.c not found..."
elif [ $NOGCC ]
then echo "Not calling C compiler."; exit 0
else exec wsc2-gcc
fi







## Run again to profile branches:
# ./query.exe
# CMD="gcc $OPTFLAGS -o query.exe $WS_LINK query.c -fbranch-probabilities"
# echo $CMD; $CMD


# GCC flags not enabled by -O3:
#       -fforce-addr
#       -funroll-loops / unroll-all-loops
#       -finline-limit=
#       -fno-keep-static-consts
#       -fmerge-all-constants (non conforming behavior)

#       -fsched-spec-load
#       -fsched-spec-load-dangerous
#       -fmove-all-movables

#       -fbranch-probabilities
#       -fno-guess-branch-probability

#       -fprefetch-loop-arrays

# Experimental:
#       -fnew-ra - Experimental register allocator
#       -ftracer
#       -fssa  - not ready for productio use
#      -ffunction-sections  -fdata-sections  -- place functions and data into their own sections, helps linker.


# Our array representation is going to require disabling:
#       -fstrict-aliasing


# May or may not increase performance (might disable)
#       -fcrossjumping
#       -freduce-all-givs
#       -falign-labels


# DANGER opts that must be turned on by hand, breaks IEEE math.
#       -ffast-math
#       -fno-math-errno
#       -funsafe-math-optimizations
#       -ffinite-math-only   - disable handling of NANs and INFs
#       -fno-trapping-math   - don't worry about DIV zero and so on
#       -fsingle-precision-constant



