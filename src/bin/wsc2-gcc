#!/bin/sh


FIRST=`head -n1 "query.c"`
MATCH=`echo $FIRST | grep "^//WSLIBDEPS:"`
if [ "$MATCH" != "" ];
then 
   EXTRALIBS=`echo $FIRST | sed "s/\/\/WSLIBDEPS://"`
   WS_LINK="$WS_LINK $EXTRALIBS"
   echo Linking extra libraries requested by query file: $EXTRALIBS
fi

#========================================

case "$COPTFLAG" in
 --O1 ) ;;
 --O2 ) 
   OPTFLAGS="-O2 ";
   ;;
 --O3 )
   # max-unroll-times Seems to be 8 by default.
   OPTFLAGS="-O3 -funroll-loops --param max-unroll-times=16 ";
   ;;
 *)
   ## DEBUG MODE:
   OPTFLAGS="-g -O0";
   ;;
esac

# Default to gcc:
if [ "$CC" = "" ]; then CC="gcc $OPTFLAGS"; 
#else echo "Using alternate C compiler $CC."; 
fi 

# Only the libraries should be included again at the end:
#WS_LINK_POST= FILTER_OUT($WS_LINK)
#WS_LINK_POST=$WS_LINK

## ACK - include WS_LINK at front and end?!?
CMD="$CC $WS_LINK -lm -I $REGIMENTD/lib -o query.exe query.c $WS_LINK_POST -lm"
echo "$CMD"
#if gcc -I$TOSROOT/support/sdk/c -L$TOSROOT/support/sdk/c -lmote -I$TOSROOT/support/sdk/c/tos/types/ -lm -g -O0 -o query.exe query.c   -I$TOSROOT/support/sdk/c -L$TOSROOT/support/sdk/c -lmote -I$TOSROOT/support/sdk/c/tos/types/

if time $CMD;
then echo Compiled .c output successfully.
else echo ERROR, gcc failed.; exit 1
fi

wc query.c
