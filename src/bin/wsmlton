
#!/bin/bash

#TMP=/tmp/`whoami`/wavescript_parsed.tmp

source `dirname $0`/assert_regimentd

FLAGS=' -verbose 1 -link-opt -lfftw3f  '
CINCLUDES="$REGIMENTD/src/generic/passes/mlton_bkend/fftw.c"


if [ ! -f "$1" ];
then echo Usage: "wsmlton <file> <options ...>";
     echo 
     echo   File \"$1\" does not exist.
     exit 1;
fi

if [ ! -d /tmp/`whoami` ]; 
then mkdir /tmp/`whoami`;
fi

D=`dirname "$1"`
B=`basename "$1"`
abspath="`cd \"$D\" 2>/dev/null && pwd || echo \"$D\"`/$B"

# Clean up first:
rm -f "query.sml"
rm -f "query.exe"

export REGIMENT_OR_WAVESCRIPT=WS
if regiment wsml $abspath ${1+"$@"} ;
then echo
else #rm -f $TMP; 
    echo Compilation aborted: \"regiment wscomp\" exited with error code.
    exit 1;
fi

#INCLUDES="-I $REGIMENTD/src/generic/passes/ocaml_bkend/fftw2-0.2"
#LIBS="bigarray.cmxa fftw2.cmxa"
#

alias runmlton="mlton -default-ann 'allowFFI true'"

#export ANNFLAG='"allowFFI true"'
#SML="mlton -default-ann $ANNFLAG "
#SML=runmlton

#SML='mlton -verbose 1 -codegen c'
#SML='mlton -verbose 1'
#SML="mlton -verbose 1 -link-opt -lfftw3f -default-ann 'allowFFI true' $REGIMENTD/src/generic/passes/mlton_bkend/fftw.c "
# mlton -link-opt -lfftw3f -default-ann 'allowFFI true' $REGIMENTD/src/generic/passes/mlton_bkend/fftw.c 
#SML=sml 

echo "mlton -default-ann 'allowFFI true' -output query.exe $FLAGS $INCLUDES query.sml $LIBS $CINCLUDES"

start=`date +%s`
if mlton -default-ann 'allowFFI true' -output query.exe $FLAGS $INCLUDES query.sml $LIBS $CINCLUDES
#runmlton -output query.exe $FLAGS $INCLUDES query.sml $LIBS $CINCLUDES
then end=`date +%s`;
     echo "  Time spent in $SML compiler: "$[($end) - ($start)]" second(s)";
     echo "Executable output to 'query.exe'.";
else echo "$SML returned error!!"; exit -1
fi
