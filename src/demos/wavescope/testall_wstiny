#!/bin/bash

# This will test wstiny in different modes. 
#

COMP=.__wstinyMessages.txt
RUN=.__runquery_output_wstiny.txt

echo > $COMP
echo > $RUN

EXEC="./query.py | head -n 20"
TELOS=

echo First arg $1
if [ "$1" = "telosb" ]; then 
  echo Running on REAL telos.
  echo Using super hackish method for killing java listener:
  EXEC="(java PrintfClient &); sleep 5; killall java"
  TELOS=true
fi

function go () {
    echo; echo; echo; echo; echo; echo; echo;  
    echo "testall_wstiny: Running $1"
    echo "============================================================"
    if ! wstiny $1 -exit-error; then exit 1; fi
    echo >> $RUN
    echo $1 : >> $RUN
    if [ "$TELOS" != "" ]; then make -f Makefile.tos2 telosb bsl,$THEMOTE install; fi 
    echo Running with $EXEC
    if ! bash -c "$EXEC" >> $RUN; then exit 1; fi
}


go "demo1c_timer.ws"


# # go "demo1d_readFile_text.ws"
# go "demo1e_readFile.ws" # no sigseg reading yet
# ###go "demo1f_readFile_sigseg.ws" 

go "demo2a_iterate.ws"
go "demo2b_iterateState.ws"

# go "demo2c_inlining.ws"
# # #go "demo2d_pullNtimer.ws" # goes forever
# # #go "demo2e_passchain.ws"

go "demo3a_tuples.ws"
# go "demo3c_lists.ws"
go "demo3d_tuples_of_tuples.ws"
# # #TEMP# go "demo3e_hashtables.ws"
# go "demo3f_morelists.ws"
# go "demo3g_arrays.ws" 
# go "demo3h_advancedlists.ws"
# go "demo3i_conversion_prims.ws"
# go "demo3j_numbers.ws"
# # go "demo3k_uniontype.ws"
# # go "demo3l_moreunions.ws"
# go "demo3m_sigsegs.ws"
# go "demo3n_static_vals.ws"

# go "demo4a_fft.ws"
# go "demo4b_morefft.ws"
# go "demo4d_quoted_constants.ws"
# go "demo4e_fifo_adt.ws"


# # # This one doesn't work for currently unknown reasons.
# # # It produces ZEROs as output...
# # #go "demo4m_fft_pipelined.ws"



# # ## Doesn't work presently.  Probably has a problem with the array-filling code generated by the constants.
# # #go "demo4c_quoted_constants.ws" 

# go "demo5a_rewindow.ws"
# go "demo5b_rewindow_inlined.ws"

# go "demo6a_unionList.ws"
# go "demo6b_sync.ws"
# go "demo6c_syncN.ws" ## [2007.10.10] SEGFAULTS!
# go "demo6e_stdlib_sync.ws"
# go "demo6f_merge.ws"

# go "demo7a_marmot_noinline.ws"
# go "demo7b_marmot_phase1.ws"

# go "demo8a_generic_arith.ws" 
# go "demo8b_sugars.ws"
# go "demo8c_moresugar.ws"

# # #go "demo9_misc_prim_tests.ws"
# # #go "demo9b_higher_order_prims.ws" # [2007.04.30] disabling for now... need to implement array equality
# # gcc -c bar.c
# # go "demo9c_foreign.ws"

# go "demo10a_simple_merge.ws"
# go "demo10b_repeated_rewindow.ws"


go "demo11g_tinyos.ws"
if [ "$TELOS" != "" ]; then go "demo11h_readstream.ws" ; fi
if [ "$TELOS" != "" ]; then go "demo11i_recorder.ws" ; fi  
go "demo11j_tos_fft.ws"
